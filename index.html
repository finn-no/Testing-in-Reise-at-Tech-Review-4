<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>testing-in-reise</title>

    <meta name="description" content="Presentation on how FINN Reise does testing held at FINN Tech Review #4 2016.06.09">
    <meta name="author" content="Stig Kleppe-Jørgensen">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/simple.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="css/highlight/styles/zenburn.css" id="highlight-theme">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <link rel="stylesheet" href="css/extra.css">

  </head>

  <body>

    <div class="reveal">
      <div class="slides"><section id="testing-in-reise" class="slide" data-has-notes="true">
<h1>Testing @ FINN Reise</h1><h4>Solfrid Wathne &amp; Stig Kleppe-Jørgensen</h4><h4>2016.06.09</h4>
</section>

<section id="why-1" class="slide" data-has-notes="true">
<h1>Why</h1><h2>or, what&#39;s in it for me?</h2><aside class="notes"><p>Hva får en ved å teste slik vi gjør i Reise?</p></aside>
</section>

<section id="why-2" class="slide" data-has-notes="true">
<h1>Why</h1><h3>Unstable test environments, you say?</h3><h3>Never heard of&#39;em</h3><aside class="notes"><p>De fleste her i salen har sikkert slitt med ustabile testmiljøer i den siste tiden. På reise merker lite av dette</p></aside>
</section>

<section id="why-3" class="slide" data-has-notes="true">
<h1>Why</h1><ul>
<li>Deploy <strong>faster</strong> &amp; <strong>safer</strong><ul>
<li>~60-110 deploys a day</li>
</ul>
</li>
<li>PR NG --&gt; no PRs --&gt; Code reviews after deployment</li>
<li>Push directly to master</li>
<li>Auto verify in pipeline</li>
<li>Safe to do large changes<ul>
<li>If tests go green everything works</li>
</ul>
</li>
</ul><aside class="notes"><p>Men den EGENTLIGE grunnen:</p>
<ul>
<li>Vi kan deploye raskere og tryggere - Vi kan pushe rett til master</li>
<li>Vi kan ha på auto verify i pipeline</li>
<li>Det er trygt å gjøre større endringer som treffer flere moduler.</li>
<li>Vi har ikke pull requests, men code reviews etter prodsetting</li>
<li>Code reviews er da mer for kompentansedeling</li>
</ul></aside>
</section>

<section id="how-1" class="slide" data-has-notes="true">
<h1>How?</h1><h2>or, TDD FTW</h2><aside class="notes"><p>Den viktigste grunnen til at vi kan gjøre dette, er at vi har kjørt TDD hele veien. Når vi lager  en ny feature, lager vi ende-til-ende-testen først før vi skriver noe funksjonell kode.</p></aside>
</section>

<section id="how-2" class="slide" data-has-notes="true">
<h1>How?</h1><h3>EVERYTHING is tested</h3><h3>The build runs EVERYTHING</h3><h3>NO manual testing</h3><aside class="notes"><p>Vi tester alt, bygget kjører alle tester og vi har ingen manuell testing.</p></aside>
</section>

<section id="how-3" class="slide" data-has-notes="true">
<h1>How?</h1><h3>Multiple levels, or strategies, of tests</h3><p>Martin Fowler&#39;s test pyramid:</p>
<image src="images/test-pyramid.svg" style="background:none; border:none; box-shadow:none;"/><aside class="notes"><p>For å få en så høy test-dekning som mulig, har vi tester på forskjellige nivåer. Som vist i test-pyramiden her, hentet fra Martin Fowler, blir det færre tester jo lenger opp en kommer. Grunnen til dette er at jo lenger opp en kommer, jo lenger tar testene å kjøre i tillegg til at de blir mer ustabile.</p></aside>
</section>

<section id="how-4" class="slide" data-has-notes="true">
<h1>How?</h1><h3>FINN Reise&#39;s test pyramid</h3><image src="images/test-pyramid-reise.svg" style="background:none; border:none; box-shadow:none;"/><aside class="notes"><p>Vi har litt andre navn på våre test-nivåer, feature i stedet for end-to-end, module i stedet for component. Våre unit tester er for det meste det samme, men vi har også noen på unit test-nivå som kan klassifiseres som integration-tester.</p></aside>
</section>

<section id="feature-tests" class="slide" data-has-notes="true">
<h2>Feature tests</h2><ul>
<li>End-2-end testing</li>
<li>Starts the whole vertical<ul>
<li>web, api, integration, solr, etc.</li>
</ul>
</li>
<li>The tests emulate a user</li>
<li>Mocks out external services<ul>
<li>Expedia, SAS, Star Tour, Ving, etc.</li>
</ul>
</li>
</ul><aside class="notes"><p>Feature tester er ende-til-ende testing, dvs. hele applikasjonen blir startet opp, frontend, api, solr, etc. Testen kjøres mot frontend ved å emulere en bruker. Den fyller ut felt, trykker på knapper/linker og sjekker hva som ligger på siden etter at &quot;brukeren&quot; har gjort noe. Her mocker vi vekk alle eksterne tjenester som expedia, sas, star tour, ving, etc.</p></aside>
</section>

<section id="module-tests" class="slide" data-has-notes="true">
<h2>Module tests</h2><ul>
<li>Starts only 1 module<ul>
<li>web or api or...</li>
</ul>
</li>
<li>2 ways of testing<ul>
<li>web modules --&gt; emulate a user</li>
<li>other modules --&gt; call the API</li>
</ul>
</li>
<li>Mocks out<ul>
<li>other modules</li>
<li>external services</li>
</ul>
</li>
</ul><aside class="notes"><p>Modultester kjører bare opp en modul, f.eks. frontend eller api-artifaktet. Hvis det er en frontend modul emuleres en bruker på samme måte som for feature testene fra forrige slide. Ellers testes modulen gjennom APIet den eksponerer. Her mocker vi ut andre moduler og eksterne tjenester slik at vi kan konsentrere oss om hva modulen gjør og ikke hvordan andre moduler/eksterne tjenester oppfører seg.</p></aside>
</section>

<section id="tools-frameworks-1" class="slide" data-has-notes="true">
<h2>Tools &amp; frameworks</h2><ul>
<li>Spock</li>
<li>Geb</li>
<li>Karma</li>
<li>BrowserStack</li>
<li>Embedded Tomcat</li>
<li>HTTP mocking</li>
<li>Thrift stubbing</li>
</ul><aside class="notes"><p>Vi bruker en del verktøy og rammeverk for å gjøre testingen enklere.</p>
<p>For de som ikke har brukt det, så er Spock et test rammeverk dvs et alternativ til JUnit. Anbefaler alle til å begynne å bruke det i stedet for JUnit. Det gjør testene mye mer konsise og lett-leste. Vi bruker det på unit, modul og feature-testene.</p>
<p>Geb brukes til frontend testing som en driver for WebDriver, dvs. det er et alternativ til Cucumber. Det blir brukt som et slags påbygg til Spock, som gjør det mulig å bruke mange av de kjekke mulighetene Spock gir ved frontend testing. Karma brukes til testing av javascript, hvor vi i tillegg til å kjøre det lokalt med PhantomJS kjører det i skyen på BrowserStack for å teste andre nettlesere, dvs. for å sjekke at det ikke krasjer i IE.</p>
<p>Vi har laget en liten test utility som kan starte opp Tomcat før testene kjører, aka embedded tomcat. Slik blir det enkelt å kjøre modul-tester fra IntelliJ.</p>
<p>Alle modulene våre snakker over http med hverandre, så det er forholdsvis enkelt å mocke vekk modul-avhengigheter ved å kjøre opp en mock http server i testene. Vi har et par thrift-tjenester vi bruker, bl.a. Broadcast, så vi fikk fikset denne slik at den passet inn i test-oppsettet vårt.</p></aside>
</section>

<section id="tools-frameworks-2" class="slide" data-has-notes="true">
<h2>Tools &amp; frameworks</h2><ul>
<li>PMD</li>
<li>Checkstyle</li>
<li>FindBugs</li>
<li>CodeNarc</li>
<li>Jasper</li>
<li>Gradle</li>
</ul><aside class="notes"><p>Vi kjører også kodesjekker i bygget, og sjekker både prod og testkode med de samme reglene. Testkoden skal alltid holde like høy kvalitet som prod-koden! Vi tester også at JSPene kompilerer ok. Disse sjekkene gjør det også tryggere å ikke ha PR. Jeg har nevnt gradle her fordi den gjør det veldig mye enklere å få til testingen vi gjør.</p></aside>
</section>

<section id="geb-spock" class="slide" data-has-notes="true">
<h2>Geb and Spock</h2><pre><code class="lang-groovy"><span class="hljs-keyword">def</span> <span class="hljs-string">'Enter credentials and login'</span>() {
<span class="hljs-symbol">  given:</span>
    at LoginPage
    <span class="hljs-keyword">def</span> uid = System.getenv(<span class="hljs-string">'FINN_UID'</span>)
    <span class="hljs-keyword">def</span> pwd = System.getenv(<span class="hljs-string">'FINN_PWD'</span>)
<span class="hljs-symbol">
  when:</span>
    email.value(uid)
    password.value(pwd)
    loginWithSPiD.click()
<span class="hljs-symbol">
  then:</span>
    at UserPage
}
</code></pre><aside class="notes"><p>Her er et eksempel på en Geb test skrevet i Spock. Den sjekker at browseren er på login-siden og setter uid/pwd fra env.vars. Deretter fyller den inn uid/pwd i formen på login-siden, for så å trykke på login-knappen. Så sjekker den at man kommer profil-siden.</p></aside>
</section>

<section id="embedded-tomcat" class="slide" data-has-notes="true">
<h2>Embedded Tomcat</h2><pre><code class="lang-groovy"><span class="hljs-meta">@Shared</span>
<span class="hljs-keyword">def</span> EmbeddedTomcat tomcat = <span class="hljs-keyword">new</span> EmbeddedTomcat()

<span class="hljs-meta">@Shared</span>
<span class="hljs-keyword">def</span> client

<span class="hljs-keyword">def</span> setupSpec() {
  tomcat.start()
  client = <span class="hljs-keyword">new</span> RESTClient(<span class="hljs-string">"http://localhost:${tomcat.port}"</span>)
}

<span class="hljs-keyword">def</span> cleanupSpec() {
  tomcat.stop()
}
</code></pre><aside class="notes"><p>Her er et eksempel på bruk av test utilitien for å kjøre opp Tomcat i en Spock test og stoppe den når testen er ferdig.</p></aside>
</section>

<section id="http-mocking" class="slide" data-has-notes="true">
<h2>HTTP mocking</h2><pre><code class="lang-groovy"><span class="hljs-keyword">def</span> setupMockForCurrencyRates(String responseFromApi) {

  clientDriver.addExpectation(

    onRequestTo(<span class="hljs-string">"/reise/valuta/"</span>).
      withMethod(GET).
      withAnyParams(),

    giveResponse(responseFromApi, JSON).
      after(<span class="hljs-number">0</span>, TimeUnit.SECONDS).
      withStatus(OK.statusCode)
  )
}
</code></pre><aside class="notes"><p>Vi bruker nå en rammeverk som heter ClientDriver for mocking av http-tjenester, i dette eksempelet mocker vi ut api-kallene for uthenting av valuta-kurser.</p></aside>
</section>

<section id="thrift-stubbing" class="slide" data-has-notes="true">
<h2>Thrift stubbing</h2><pre><code class="lang-groovy"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BroadcastTestServer</span> {</span>
  <span class="hljs-keyword">public</span> BroadcastTestServer() {
    broadcastServer = <span class="hljs-keyword">new</span> BroadcastServer(
      <span class="hljs-keyword">new</span> BroadcastServiceHandler(<span class="hljs-keyword">new</span> BroadcastMessageDaoStub()));
    <span class="hljs-keyword">int</span> port = findFreePort();
    broadcastServer.setPort(port);
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> start() {
    copyIniFileToTmpDir();
    broadcastServer.start();
  }

  <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> stop() {
    deleteTempIniFileIfExists();
    broadcastServer.stop();
  }
</code></pre><aside class="notes"><p>Dette er en test utility for å stubbe ut kall til broadcast-serveren. Dvs. at denne kjøres opp før testene. I andre tester der vi ikke tester at broadcast fungerer, slår vi den av med en config-fil.</p></aside>
</section>

<section id="work-with-us" class="slide" data-has-notes="true">
<h2>Come work with us!</h2><aside class="notes"><p>For de som vil lære mer om hvordan vi gjør testing, er det bare å spørre nærmeste sjef om å få lov til å hospitere hos oss!</p></aside>
</section></div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>
    // Full list of configuration options available at:
    // https://github.com/hakimel/reveal.js#configuration
    Reveal.initialize({
      controls: true,
      progress: true,
      history: true,
      center: true,

      transition: Reveal.getQueryHash().transition || 'slide', // none/fade/slide/convex/concave/zoom

      // Optional reveal.js plugins
      dependencies: [
        //{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        //{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
        //{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
        { src: 'plugin/zoom-js/zoom.js', async: true },
        { src: 'plugin/notes/notes.js', async: true }
      ]
    });
    </script>

    <script src="js/dynamic-theme.js"></script><script src="js/such-notes-print.js"></script>

  </body>
</html>
